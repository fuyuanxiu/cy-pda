<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>SMT机台信息</title>
		<script src="../js/mui.min.js"></script>
		<script src="../js/api.js"></script>
		<script src="../js/jquery-1.11.1.js"></script>
		<script src="../js/jquery.xml2json.js.js"></script>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/comment.css" />
		<link rel="stylesheet" type="text/css" href="../css/iconfont.css" />

		<script src="../js/echarts.min.js"></script>

		<style type="text/css">
			.chart {
				height: 200px;
				margin: 0px;
				padding: 0px;
			}

			.mui-input-group .mui-input-row {
				height: 37px;
			}

			.mui-input-row label {
				width: 45%;
			}

			.mui-input-row label~input,
			.mui-input-row label~select,
			.mui-input-row label~textarea {
				float: right;
				width: 55%;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav  mui-bar-transparent colorBg">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" id="title">加载中..</h1>
			<a class="mui-pull-right"><span class="title-right" id="usr"></span></a>
		</header>
		<div class="mui-content">
			<div class="mui-row">
				<div class="mui-col-sm-4 mui-col-xs-12">
					<img style="margin-left: 10px;" width="95%" src="../img/smt.png" />
					<div class="chart" id="yibiaoChart"></div>
					<ul class="mui-table-view" id="order">
						<li class="mui-table-view-cell" data-name="产出信息">
							<a class="mui-navigate-right">产出信息
								<span class="mui-badge mui-badge-primary" id="outputinfo"></span>
							</a>
						</li>
						<li class="mui-table-view-cell" data-name="停机信息">
							<a class="mui-navigate-right">停机信息
								<span class="mui-badge mui-badge-success" id="downinfo"></span>
							</a>
						</li>
					</ul>
				</div>
				<div class="mui-col-sm-5 mui-col-xs-12">
					<div class="mui-input-group">
						<div class="mui-input-row">
							<label id="linedeviceslabel"><span class="mui-icon iconfont icon-saomiao"></span>线体机台':</label>
							<input type="text" id="linedevices" disabled="true">
						</div>
						<div class="mui-input-row">
							<label><span class="mui-icon iconfont icon-saomiao"></span>当前品号:</label>
							<input type="text" id="item" value="加载中..." disabled="true">
						</div>
						<div class="mui-input-row">
							<label> 当前品名:</label>
							<input type="text" id="itemname" disabled="true">
						</div>
						<div class="mui-input-row">
							<label id="processlabel"><span class="mui-icon iconfont icon-saomiao"></span>当前工序':</label>
							<input type="text" id="process" disabled="true">
						</div>

						<div class="mui-input-row">
							<label id="machinetimelabel"><span class="mui-icon iconfont icon-saomiao"></span>计划机时':</label>
							<input type="text" id="machinetime" disabled="true">
						</div>
						<div class="mui-input-row">
							<label id="targetpointslabel"><span class="mui-icon iconfont icon-saomiao"></span>目标点数':</label>
							<input type="text" id="targetpoints" disabled="true">
						</div>
						<div class="mui-input-row">
							<label id="sumtimelabel"><span class="mui-icon iconfont icon-saomiao"></span>统计时长':</label>
							<input type="text" id="sumtime" disabled="true">
						</div>
						<div class="mui-input-row">
							<label id="runningtimelabel"><span class="mui-icon iconfont icon-saomiao"></span>运行时长':</label>
							<input type="text" id="runningtime" disabled="true">
						</div>
						<div class="mui-input-row">
							<label id="outputpointslabel"><span class="mui-icon iconfont icon-saomiao"></span>产出点数':</label>
							<input type="text" id="outputpoints" disabled="true">
						</div>

						<div class="mui-input-row">
							<label id="currentefficiencylabel"><span class="mui-icon iconfont icon-saomiao"></span>当前效率':</label>
							<input type="text" id="currentefficiency" disabled="true">
						</div>
						<div class="mui-input-row">
							<label id="goalcompletelabel"><span class="mui-icon iconfont icon-saomiao"></span>目标达成':</label>
							<input type="text" id="goalcomplete" disabled="true">
						</div>

						<div class="mui-input-row">
							<label id="downtimelabel"><span class="mui-icon iconfont icon-saomiao"></span>停机时长':</label>
							<input type="text" id="downtime" disabled="true">
						</div>
						<div class="mui-input-row">
							<label id="outputboardslabel"><span class="mui-icon iconfont icon-saomiao"></span>当前产出板数:</label>
							<input type="text" id="outputboards" disabled="true">
						</div>
					</div>
				</div>
				<div class="mui-col-sm-3 mui-col-xs-12">
					<ul class="mui-table-view mui-grid-view mui-grid-9" id="btnList">
						<li class="mui-table-view-cell mui-media mui-col-xs-6 mui-col-sm-6 bg1">
							<div class="inner" onclick="OpenWindow('main_smt','/main_smt.html','')">
								<div class="disc">主页</div>
							</div>
						</li>
						<li class="mui-table-view-cell mui-media mui-col-xs-6 mui-col-sm-6 bg1">
							<div class="inner" onclick="toSwitchline()">
								<div class="disc">转线</div>
							</div>
						</li>
						<li class="mui-table-view-cell mui-media mui-col-xs-6 mui-col-sm-6 bg1">
							<div style="height: 9.8rem;">
							</div>
						</li>
					</ul>
					<div class="chart" id="barChart"></div>
				</div>
			</div>

		</div>
		<nav class="mui-bar mui-bar-tab colorBg">
			<div class="mui-card-footer nav-word">
				<span id="slogan"></span>
			</div>
		</nav>
		<script type="text/javascript" charset="utf-8">
			window.addEventListener('refresh', function(e) { //监听页面返回事件
				window.location.reload(); //执行刷新
			});

			mui.init({
				beforeback: function() { //页面返回时触发
					var list = plus.webview.currentWebview().opener();
					mui.fire(list, 'refresh'); //refresh是A页面自定义事件
					return true; //返回true,继续页面关闭逻辑
				}
			});
			var line_code = "";
			var line_name = "";
			var timer;
			mui.plusReady(function() {
				byId("usr").innerHTML = setUsrCode();
				var param = plus.webview.currentWebview(); //获取父页面传递过来的参数
				line_code = param.lineno;
				line_name = param.linename
				var item = param.item;
				//console.log("line_code:"+line_code+"line_name:"+ line_name+"item:"+ item)
				byId("slogan").innerHTML = slogan();
				getLineTableData(line_code, line_name, item);
			})

			function toSwitchline() {
				OpenWindow('switchline', '/web/switchline.html', {
					"line_code": line_code,
					"line_name": line_name
				});
			}

			function setBarChart(bardata) {
				var barChart = echarts.init(byId('barChart'));
				barChart.setOption(chartOption = { //piechart->barchart-2020-7-8 //柱状图
					title: {
						subtext: '工时数据',
						subtextStyle: {
							color: '#000000'
						},
						left: 'center'
					},
					xAxis: {
						type: 'category',
						data: ['统计时长', '运行时长', '停机时长'],
						axisTick: { //x轴刻度线
							show: false
						},
					},
					yAxis: {
						type: 'value',
						name: '小时',
						splitLine: {
							show: false
						},
						axisTick: { //y轴刻度线
							show: false
						},

						axisLabel: {
							show: false
						}

					},
					series: [{
						data: [bardata[0], bardata[1], bardata[2]],
						type: 'bar',
						itemStyle: {
							normal: {
								color: function(params) {
									var colorList = ['#4169E1', '#32CD32', '#DC143C'];
									return colorList[params.dataIndex];
								},
								label: {
									show: true, //开启显示
									position: 'top', //在上方显示
									textStyle: { //数值样式
										color: 'black',
										fontSize: 16
									}
								}
							}
						}
					}]
				});
			}

			function setYiBioaChart(efficiency) {
				var yibiaoChart = echarts.init(byId('yibiaoChart'));
				yibiaoChart.setOption(option = { //仪表盘
					series: [{
						name: '业务指标',
						type: 'gauge',
						center: ['30%', '50%'], //位置
						radius: '59%', //大小
						detail: {
							formatter: '{value}%',
							fontSize: 22
						},
						axisLine: { // 坐标轴线
							lineStyle: { // 属性lineStyle控制线条样式
								width: 4
							}
						},
						axisLabel: {
							show: false,
						},
						data: [{
							value: efficiency[0],
							name: '当班效率'
						}]
					}, {
						name: '业务指标',
						type: 'gauge',
						center: ['70%', '50%'], //位置
						radius: '59%', //大小
						detail: {
							formatter: '{value}%',
							fontSize: 22
						},
						axisLine: { // 坐标轴线
							lineStyle: { // 属性lineStyle控制线条样式
								width: 4
							}
						},
						axisLabel: {
							show: false,
						},
						data: [{
							value: efficiency[1],
							name: '达成率'
						}]
					}]
				});
			}
			mui("#order").on("tap", "li", function() {
				var data_name = this.getAttribute('data-name');
				var id = "";
				var url = ";"
				if (data_name == "产出信息") {
					id = "single_prodinfo";
					url = "/web/single_prodinfo.html";
				} else { //停机信息
					id = "single_stop_info";
					url = "/web/single_stop_info.html"
				}
				OpenWindow(id, url, {
					"line_code": line_code
				});
			});

			function getLineTableData(lineno, line_name, item) { //获取表格内参数
				jQueryWeb("SMT_Get_InfoByLineCode_PAD", {
						"Line_Code": lineno
					},
					function(xmlHttpRequest, status) {
						if (status == 'success') { //输出json格式内容															
							var json_obj = $.xml2json(xmlHttpRequest.responseXML);
							//console.log(json_obj);
							var data = eval('(' + json_obj + ')'); //string->JSON格式
							//console.log(JSON.stringify(data));
							$('#item').val(item); //当前品号
							$('#title').text(line_name); //标头
							//统计时长，运行时长，停机时长
							var runningtime, downtime, alltime;
							//当班效率、目标达成
							var data1, data2;
							for (var i = 0; i < data.length; i++) {
								if (data[i].ITEM == "当前班次") {
									$('#title').text(line_name + "(" + data[i].VALUE + ")"); //标头
								} else if (data[i].ITEM == "当前品名") {
									$('#itemname').val(data[i].VALUE); //当前品名
								} else if (data[i].ITEM == "当前工序") {
									$('#processlabel').text(data[i].ITEM + "：");
									$("#process").val(data[i].VALUE); //当前工序 
								} else if (data[i].ITEM == "计划机时") {
									$('#machinetimelabel').text(data[i].ITEM + "：");
									$('#machinetime').val(data[i].VALUE); //计划机时
								} else if (data[i].ITEM == "目标点数") {
									$('#targetpointslabel').text(data[i].ITEM + "：");
									$('#targetpoints').val(data[i].VALUE); //目标点数
								} else if (data[i].ITEM == "运行时长") {
									$('#runningtimelabel').text(data[i].ITEM + "：");
									$('#runningtime').val(data[i].VALUE); //运行时间（长）
									runningtime = parseFloat(data[i].VALUE);
								} else if (data[i].ITEM == "当班总点数") {
									$('#outputpointslabel').text(data[i].ITEM + "：");
									$('#outputpoints').val(data[i].VALUE); //产出点数/当班总点数
								} else if (data[i].ITEM == "当班效率") {
									$('#currentefficiencylabel').text(data[i].ITEM + "：");
									$('#currentefficiency').val(data[i].VALUE); //当班（前）效率
									data1 = data[i].VALUE.substring(0, data[i].VALUE.indexOf("%"));
								} else if (data[i].ITEM == "目标达成") {
									$('#goalcompletelabel').text(data[i].ITEM + "：");
									$('#goalcomplete').val(data[i].VALUE); //目标达成
									data2 = data[i].VALUE.substring(0, data[i].VALUE.indexOf("%"));
								} else if (data[i].ITEM == "停机时长") {
									$('#downtimelabel').text(data[i].ITEM + "：");
									$('#downtime').val(data[i].VALUE); //停机时长
									downtime = parseFloat(data[i].VALUE.substring(0, data[i].VALUE.indexOf(";")));
								} else if (data[i].ITEM == "当班产出板数") {
									$('#outputboardslabel').text(data[i].ITEM + "：");
									$('#outputboards').val(data[i].VALUE); //当班产出板数
								} else if (data[i].ITEM == "停机信息") {
									$('#downinfo').text(data[i].VALUE); //停机信息
								} else if (data[i].ITEM == "产出信息") {
									$('#outputinfo').text(data[i].VALUE); //产出信息
								} else if (data[i].ITEM == "统计时长") {
									$('#sumtimelabel').text(data[i].ITEM + "：");
									$('#sumtime').val(data[i].VALUE); //停机时长
									alltime = parseFloat(data[i].VALUE.substring(0, data[i].VALUE.indexOf(";")));
								} else if (data[i].ITEM == "线体机台") {
									$('#linedeviceslabel').text(data[i].ITEM + "：");
									$('#linedevices').val(data[i].VALUE); //产出信息
								}
							}
							var timedata = [alltime, runningtime, downtime];
							setBarChart(timedata); //建立柱状图
							//建立仪表盘													
							var temp_data = [data1, data2];
							setYiBioaChart(temp_data);
						} else {
							mui.alert("获取SMT_Get_InfoByLineCode_PAD数据失败");
						}
					});
			}
		</script>
	</body>
</html>
