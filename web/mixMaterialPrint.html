<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>拌料标签打印</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.css" rel="stylesheet" />
		<script src="../js/mui.min.js"></script>
		<script src="../js/api.js"></script>
		<script src="../js/jquery.js"></script>
		<script src="../js/jquery-1.11.1.js"></script>
		<script src="../js/jquery.xml2json.js.js"></script>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<script src="../js/mui.picker.min.js"></script>
		<script src="../js/template-web.js"></script>
		<link rel="stylesheet" type="text/css" href="../css/mui.picker.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="css/common.css" />
		<link rel="stylesheet" type="text/css" href="../css/comment.css" />
		<style>
			.select-dialog {
				position: fixed;
				margin-top: 1.25rem;
				z-index: 999;
			}
			
			.result-dialog {
				position: fixed;
				margin-top: 0.85rem;
				z-index: 999;
			}
			
			.dialog-label {
				font-size: 14px;
			}
			select {
				background: url(../img/right-arrow.png) no-repeat right center;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">拌料标签打印</h1>
		</header>
		<dialog id="selectDialog" class="select-dialog" style="width: 95%;">
					<!-- <table id="mixTable" border="1">
						<tr style="width: 90%;text-align: center;"><td>123456</td></tr>
					<tr style="width: 90%;text-align: center;"><td>123456</td></tr>
					<tr style="width: 90%;text-align: center;"><td>123456</td></tr> -->
					<ul class="mui-table-view" style="height:12.5rem;overflow:auto;" id="mixList">
					   <!-- <li class="mui-table-view-cell">Item 1</li>
					    <li class="mui-table-view-cell">Item 2</li>
					    <li class="mui-table-view-cell">Item 3</li>
						<li class="mui-table-view-cell">Item 3</li>
						<li class="mui-table-view-cell">Item 3</li>
						<li class="mui-table-view-cell">Item 3</li>
						<li class="mui-table-view-cell">Item 3</li>
						<li class="mui-table-view-cell">Item 3</li>
						<li class="mui-table-view-cell">Item 3</li>
						<li class="mui-table-view-cell">Item 3</li>
						<li class="mui-table-view-cell">Item 3</li> -->
					</ul>
						
		<!-- 				<tr>
							<td>1</td>
							<td>303010000000</td>
							<td>打算大苏打</td>
							<td>广东省撒大苏打实打实</td>
						</tr>
						<tr>
							<td>1</td>
							<td>303010000000</td>
							<td>打算大苏打</td>
							<td>广东省撒大苏打实打实</td>
						</tr>
						<tr>
							<td>1</td>
							<td>303010000000</td>
							<td>打算大苏打</td>
							<td>广东省撒大苏打实打实</td>
						</tr>
						<tr>
							<td>1</td>
							<td>303010000000</td>
							<td>打算大苏打</td>
							<td>广东省撒大苏打实打实</td>
						</tr> -->
					</table>
				</dialog>
		<div class="mui-content">
			<div id="slider" class="mui-slider">
				<div class="mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" id="segmented">
					<div class="mui-scroll">
						<a class="mui-control-item mui-active" href="#item1mobile">
							操作
						</a>
						<a class="mui-control-item" href="#item2mobile">
							扫入原料
						</a>
					</div>
				</div>
				<div class="mui-slider-group">
					<div id="item1mobile" class="mui-slider-item mui-control-content mui-active">
						<form class="mui-input-group">
							<div class="mui-input-row">
								<label onclick="clicked('commom/saomiao.html','materialCode','web/mixMaterialPrint.html');">原料条码:</label>
								<input type="text" id="materialCode" class="mui-input-clear" placeholder="请扫描">
							</div>
							<div class="mui-input-row">
								<label>扫入数:</label>
								<input type="text" readonly="readonly" id="scanNum" class="mui-input">
							</div>
							<div class="mui-input-row">
								<label>拌料类型:</label>
								<input id="mixType" readonly="readonly" placeholder="请选择拌料类型" type="text" class="mui-input"
									style="width: 51%;float: left;">
								<button type="button" id="getMixType" style="width:13%; height: inherit;"
									class="mui-btn-primary">...</button>
							</div>
							<div class="mui-input-row">
								<label>电子秤:</label>
								<input type="text" id="elecScale" class="mui-input"  style="width: 51%;float: left;font-size: 17px;">
								<button type="button" id="getElecScale"
									style="width:14%; height: inherit;font-size: 12px;color: #000000;" class="mui-btn-grey">读取</button>
							</div>
							<div class="mui-input-row">
								<label>重量:</label>
								<input type="text" id="weight" readonly="readonly" class="mui-input" style="width: 50%;float: left;">
								<select id="weightUnit" class="mui-select" style="width:12%; height: inherit;">
									<option value="KG">KG</option>
									<option value="G">G</option>
								</select>
							</div>
							<div class="mui-input-row">
								<label>打印机:</label>
								<input type="text" id="printCode" class="mui-input">
							</div>
							<div class="mui-input-row">
								<label>拌料人工号:</label>
								<input type="text" id="mixNo" class="mui-input">
							</div>
				
						</form>
						
						<div class="mui-content-padded" align="center">
							<button type="button" style="margin-top: 0.625rem;" class="mui-btn mui-btn-success" data-loading-icon="mui-spinner mui-spinner-custom"
								id="print">打印</button>
							<button type="button" style="margin-top: 0.9375rem;" class="mui-btn mui-btn-warning"
								id="close">关闭</button>
						</div>
						<!-- <div class="mui-content-padded" align="center">
							<button type="button" class="mui-btn mui-btn-success" data-loading-icon="mui-spinner mui-spinner-custom" id="submit_code">确定</button>
							<button type="button" style="margin-top: 0.625rem;" class="mui-btn mui-btn-warning" id="clean_code">清空</button>
							<button type="button" style="margin-top: 0.625rem;" class="mui-btn mui-btn" id="history_code">历史记录</button>
						</div> -->
					</div>
					<div id="item2mobile" class="mui-slider-item mui-control-content ">
						<div id="code_list">
						</div>
						<script id='code-template' type="text/template">
							<% for(var i in record){ var item=record[i];%>
							<div class="mui-card">
								<div class="mui-card-header">
									<span><%=(item.barcode)%>(原料条码)</span>
								</div>
								<div class="mui-card-content">
									<ul class="mui-table-view">
										<li class="mui-table-view-cell mui-media">
												<div class="mui-media-body">
													<span>品号：<%=(item.goodsNo)%></span>
												</div>
										</li>
									</ul>
									<div class="mui-card-footer">
										<span>类型：<%=(item.type)%></span>
										<span>
											重量：<%=(item.weight)%>
											</span>
									</div>
								</div>
							</div>
							<%}%>
						</script>
					</div>
				</div>
			</div>
	</body>
	<script type="text/javascript">
		var barcodeList=[];
		window.addEventListener("offline", function(e) {
			alert("网络中断，请检查网络");
		})
		
		window.addEventListener("online", function(e) {
			mui.toast("网络已连接")
		})
		
		mui.init();
		window.addEventListener("changeBar", function(e) {
			var inputId = e.detail.inputId
			document.getElementById(inputId).value = e.detail.barcode
		});
		mui.plusReady(function() {
			document.getElementById("close").addEventListener('tap',function(){
				OpenWindow('main','main.html',{})
			})
		 getScaleNoAndWeight();
		 getPrintAndMix();
		})
		//原料条码扫入是否成功，成功扫入数+1
		$('#materialCode').bind('keyup', function(event) {
			if (event.keyCode == "13") { //输入回车执行
			var num=$("#scanNum").val();
			// $("#scanNum").val($("#scanNum").val()==""?1:++num)
			// $("#materialCode").val("")
			for (var i = 0; i < barcodeList.length; i++) {
				if(barcodeList[i].barcode==$("#materialCode").val()){
					mui.alert("不能扫入重复条码");
					$("#materialCode").val("")
					return false;
				} 
			}
			jQueryWeb("YlBarcodeInfo_ZS",{
				"inBarcode": $("#materialCode").val()
			},function(xmlHttpRequest, status){
				if(status='success'){
					var json_obj = $.xml2json(xmlHttpRequest.responseXML)
					var data = json_obj.diffgram.NewDataSet.Table;
					// console.log(data.RESULT)
					if(data.RESULT=="OK"){
						// for (var i = 0; i < barcodeList.length; i++) {
						// 	list=barcodeList[i].barcode+"@"
						// }
						// console.log(list);
						// for (var i = 0; i < barcodeList.length; i++) {
							
						// }
						var arr = {}; //元素组成
						arr["barcode"] = data.原料条码;
						arr["goodsNo"] = data.品号;
						arr["type"] = data.原料类型;
						arr["weight"] = data.数量;
						barcodeList.push(arr);
                        // console.log(JSON.stringify(barcodeList)) 
						document.getElementById('code_list').innerHTML = template('code-template', {
							"record": barcodeList
						});
						$("#scanNum").val($("#scanNum").val()==""?1:++num)
						// console.log(JSON.stringify(data))
						$("#materialCode").val("")
					}else{
						mui.alert(data.RESULT)
					}
				}
	                  			
				
			})
			}
		});
		
		$("#getMixType").click(function(){
			getMixTypeList();
			byId("selectDialog").style.display="block";
		})
        
		function getMixTypeList(){
			jQueryWeb("BLtype_ZS", "", function(xmlHttpRequest, status) {
				if (status == 'success') {
					var json_obj = $.xml2json(xmlHttpRequest.responseXML)
					var data = json_obj.diffgram.NewDataSet.Table;
					// console.log(JSON.stringify(data))
					// console.log($("#mixList li").length)
					if($("#mixList li").length!=0){
						$("#mixList li").remove();
					}
				    for (var i = 0; i < data.length; i++) {
						$("#mixList").append("<li class=\"mui-table-view-cell\">"+data[i].BLTYPE+"</li>")
				    }
				}
			})
			
		}
		$("ul#mixList").on("click","li",function(){      //只需要找到你点击的是哪个ul里面的就行
		     $("#mixType").val($(this).text());
			  byId("selectDialog").style.display = "none";
		 });
		 $("#getElecScale").click(function(){
		 	var scaleNo=$("#elecScale").val();
		 	var selectedWeight=$("#weightUnit option:selected").text()
		 	if(scaleNo==""){
		 		mui.alert("请先扫入电子秤编码")
		 		return false;
		 	}
		 	jQueryWeb("GetScaleInfo", {
		 		"ScaleMAC": scaleNo,
		 		"inUNIT": selectedWeight
		 	}, function(xmlHttpRequest, status) {
		 		if (status == 'success') {
		 			var json_obj = $.xml2json(xmlHttpRequest.responseXML);
		 			console.log(json_obj)
		 			if(json_obj.indexOf("NG")!=-1){
		 				mui.alert(json_obj)
		 			}else{
		 				$("#weight").val(json_obj)
		 				api_localStorageSave("scaleCode",scaleNo);
		 			}
		 			
		 		}
		 	})
		 });
		 $("#weightUnit").change(function(){
		 	var selected=$(this).children('option:selected').val();
		 	api_localStorageSave("selectWeight",selected);
		 	// console.log(selected)
		 })
		 function getScaleNoAndWeight(){
		 	if(api_localStorageGet("scaleCode")!=null){
		 		$("#elecScale").val(api_localStorageGet("scaleCode"));
		 	}
		 	if(api_localStorageGet("selectWeight")!=null){
		 		$("#weightUnit").val(api_localStorageGet("selectWeight"))
		 		// api_localStorageSave("selected","");
		 	}else{
		 		$("#weightUnit").val("KG")
		 	}
		 }
		 $('#printCode').bind('keyup', function(event) {
		 	if (event.keyCode == "13") { //输入回车执行
		 	     api_localStorageSave("printCode",$('#printCode').val());
		 		 // console.log(api_localStorageGet("printNo"))
		 	}
		 })
		 $('#mixNo').bind('keyup', function(event) {
		 	if (event.keyCode == "13") { //输入回车执行
			   jQueryWeb("PDA_GET_NAME_BY_CODE",{
				   "inWorkCode": $('#mixNo').val(),
				   "OnJobCheck": "Y"
			   },function(xmlHttpRequest, status){
		 		if(status== 'success'){
		 			var json_obj = $.xml2json(xmlHttpRequest.responseXML)
		 			var data = json_obj;
					$('#mixNo').val(data)
					api_localStorageSave("mixNo",data);
		 		}
				})
		 	     
		 	}
		 })
		 //获取拌料人工号和打印机
		 function getPrintAndMix(){
			 // console.log(api_localStorageGet("printCode"))
			 if(api_localStorageGet("printCode")!=null){
			 	$("#printCode").val(api_localStorageGet("printCode"));
			 }
			 if(api_localStorageGet("mixNo")!=null){
			 	$("#mixNo").val(api_localStorageGet("mixNo"));
			 }
		 }
		 //获取打印数据
		 $("#print").click(function(){
			 var list="";
			 for (var i = 0; i < barcodeList.length; i++) {
			 	list+=barcodeList[i].barcode+"@"
			 }
		 	var InBarcoeS=list;
		 	var BlType=$("#mixType").val();
		 	var weight=$("#weight").val();
		 	var unit=$("#weightUnit option:selected").text();
			var PrintCode=$("#printCode").val();
			var BlUserCode=$("#mixNo").val();
		 	var userCode= api_localStorageGet("code");
		 	// console.log("类型"+type+";品号"+itemNo+";供应商"+supplier+";编号"+printNo+";重量"+weight+";单位"+unit+";账号"+userCode+";打印份数"+PrintQty);
		 	jQueryWeb("YlBl_ZS",{
		 		"InBarcoeS": InBarcoeS,
		 		"BlType": BlType,
		 		"Weight": weight,
		 		"Unit": unit,
				"PrintCode": PrintCode,
				"BlUserCode": BlUserCode,
		 		"UserCode" : userCode
		 	},function(xmlHttpRequest, status){
		 		if(status== 'success'){
		 			var json_obj = $.xml2json(xmlHttpRequest.responseXML)
		 			var data = json_obj;
		 			if(data.indexOf("NG")!=-1){
		 				mui.alert(data)
		 			}else if(data=="OK"){
		 				mui.toast("打印成功")
				        barcodeList=[];
						clean(barcodeList)
		 				$("#materialCode").val("");
		 				$("#scanNum").val("");
						$("#mixType").val("");
		 				$("#weight").val("");
		 			}else{
		 				mui.alert(data)
		 			}
		 		}
		 	})
		 })
		 function clean(barcodeList){
			 document.getElementById('code_list').innerHTML = template('code-template', {
			 	"record": barcodeList
			 });
		 }
		function clicked(url, f1, urlId) {
			OpenWindow(f1, url, {
				urlId: urlId,
				inputId: f1
			});
		};
	</script>
</html>
